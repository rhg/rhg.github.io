<body>
  <!DOCTYPE html>
<html lang="en">
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta content="" name="keywords">
<meta content="What to Pass: a Var or IFn? - tehblog" property="og:title">
<title>What to Pass: a Var or IFn? | tehblog</title>
<link rel="stylesheet" href="https://rhg135.com/css/style.css">
<link href="//maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN" crossorigin="anonymous">

<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">


  <section class="section">
  <div class="container">
    <nav class="nav">
      <div class="nav-left">
        <a class="nav-item" href="https://rhg135.com/"><h1 class="title is-4">tehblog</h1></a>
      </div>
      <div class="nav-right">
        <nav class="nav-item level is-mobile">
          
          <a class="level-item" href="https://github.com/rhg">
            <span class="icon">
              <i class="fa fa-github"></i>
            </span>
          </a>
          
          <a class="level-item" href="https://twitter.com/rhg135">
            <span class="icon">
              <i class="fa fa-twitter"></i>
            </span>
          </a>
          
          <a class="level-item" href="/index.xml">
            <span class="icon">
              <i class="fa fa-rss"></i>
            </span>
          </a>
          
        </nav>
      </div>
    </nav>
  </div>
</section>

  <section class="section">
    <div class="container">
      <h2 class="subtitle is-6">August 23, 2015</h2>
      <h1 class="title">What to Pass: a Var or IFn?</h1>
      
      <div class="tags">
    
        <a class="button is-link" href="/tags/clojure">clojure</a>
    
        <a class="button is-link" href="/tags/code">code</a>
    
</div>

      
      <div class="content">
        

<h2 id="mapping-a-function-over-a-channel">Mapping a function over a channel</h2>

<p>You have a function you are developing:</p>

<pre><code>(defn name-string
  &quot;Gives you the name string from a suitable map&quot;
  [{:keys [first-name]}]
  first-name)
</code></pre>

<p>and you want to run this on maps you get over, say, a socket. Thus you shove it up a channel with an attached transducer of <code>(map name-string)</code> (or with a pipeline of the actual data channel, for the indirection).</p>

<h2 id="a-problem-arises">A Problem Arises</h2>

<p>Now, you want to incorporate the last name as an initial. Thus:</p>

<pre><code>(defn name-string
  &quot;Gives you a first name with a last name initial&quot;
  [{:keys [first-name last-name]}]
  (str first-name \space (first last-name) &quot;.&quot;))
</code></pre>

<p>But, oh noes! The old definition is still used. Naïvely you would restart the input source (or if you did use indirection, point it to a new channel). There is a better way, for development purposes. This does incur a small overhead and allows a feature which may be a security hole in production.</p>

<h2 id="what-is-a-function">What is <code>a-function</code></h2>

<p>This will resolve at compile time to the current value of the var named by the symbol (or just the value bound to it if a local). This is usually an IFn instance if it&rsquo;s a function. This works fine and dandy in a language with no runtime definitions—<em>cough</em> java *cough*—but it falls flat when used in a dynamic language. It is consistent and logical, unfortunately it does sometimes surprise people when redefinitions do nothing.</p>

<h2 id="what-is-a-function-1">What Is #&lsquo;a-function</h2>

<p>At read time this will turn to <code>(var a-function)</code>. At runtime it evaluates to a <code>clojure.lang.Var</code> object if a-function is a global. The meta-magic here is that <code>Var</code> implements <code>IFn</code>, and if it&rsquo;s a var for a function, invoking the var will invoke the function the var currently points at. I can hear thosee of you saying &ldquo;that&rsquo;s a reference,&rdquo; and you are indeed correctish. <code>Var</code>s are one in the sense they allow mutability, but they also don&rsquo;t allow much else. You can also change the root binding atomically (I think), and if it is marked dynamic (by having <code>:dynamic true</code> in the metadata) you can change the current thread binding for a function call.</p>

<h2 id="just-show-me-the-codes">Just Show Me The Codes!</h2>

<pre><code>(require '[clojure.core.async :as a])
;=&gt; nil

(defn my-char
  [x]
  (char x))
;=&gt; #'user/my-char

(def ch (a/chan 1 (map my-char)))
;=&gt; #'user/ch

(a/&gt;!! ch 97)
;=&gt; true

(a/&lt;!! ch)
;=&gt; \a

; now let's redefine our function

(alter-var-root #'my-char comp inc)

; now it incs the number before turning it to a character

(a/&gt;!! ch 97)
;=&gt; true

(= \b (a/&lt;!! ch))
;=&gt; false

; oh noez! press the panic button!

; or do this when creating the channel

(defn my-char
  [x]
  (char x))
;=&gt; #'user/my-char

(def ch (a/chan 1 (map #'my-char)))
;=&gt; user/ch

(a/&gt;!! ch 97)
;=&gt; true

(= \a (a/&lt;!! ch))
;=&gt; true

(alter-var-root #'my-char comp inc)
;=&gt; an instance of IFn

(a/&gt;!! ch 97)
;=&gt; true

(= \b (a/&lt;!! ch))
;=&gt; true

; yay!
</code></pre>

      </div>
    </div>
  </section>
  

  <section class="section">
  <div class="container has-text-centered">
    <p>No Rights Reserved <a href="https://github.com/rhg">Ricardo Gomez</a></p>
  </div>
</section>
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js" integrity="sha256-/BfiIkHlHoVihZdc6TFuj7MmJ0TWcWsMXkeDFwhi0zw=" crossorigin="anonymous"></script>

<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/clojure.min.js"></script>

<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/java.min.js"></script>

<script>hljs.initHighlightingOnLoad();</script>


</body>
